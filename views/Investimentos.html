<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PayFly - Investimentos</title>
    <link rel="icon" type="image/png" href="../view/imgs/Favicon.png" />

    <!-- ======= Estilos ====== -->
    <link rel="stylesheet" href="../views/css/style.css" />
    <link rel="stylesheet" href="../views/css/data-tables.css" />

    <!-- Script ULTRA AGRESSIVO para for√ßar estilos -->
    <script>
      // Sistema √∫nico de limpeza - SEM LOOPS
      let tableStylesFixed = false;

      function cleanTableStyles() {
        if (tableStylesFixed) return; // Executa apenas UMA vez

        console.debug("üßπ Limpando estilos de tabela...");

        // Remove backgrounds apenas das linhas de dados (tbody tr)
        const dataRows = document.querySelectorAll("tbody tr");
        dataRows.forEach((row) => {
          row.style.setProperty("background", "#ffffff", "important");
          row.style.setProperty("background-image", "none", "important");
        });

        // Marca como conclu√≠do
        tableStylesFixed = true;
        console.debug("‚úÖ Estilos limpos");
      }

      // Executa apenas uma vez ap√≥s DOM carregar
      document.addEventListener("DOMContentLoaded", function () {
        setTimeout(cleanTableStyles, 500); // Aguarda carregamento completo
      });
    </script>
  </head>

  <body>
    <!-- =============== Menu Navega√ß√£o ================ -->
    <div class="container">
      <div class="navigation">
        <ul>
          <li>
            <a href="#">
              <span class="icon">
                <img src="../views/imgs/logo.svg" alt="Logo" />
              </span>
              <span class="title">PayFly</span>
            </a>
          </li>

          <li>
            <a href="Painel.html">
              <span class="icon">
                <ion-icon name="home-outline"></ion-icon>
              </span>
              <span class="title">Painel Principal</span>
            </a>
          </li>

          <li>
            <a href="Despesas.html">
              <span class="icon">
                <ion-icon name="cart-outline"></ion-icon>
              </span>
              <span class="title">Despesas</span>
            </a>
          </li>

          <li>
            <a href="Receitas.html">
              <span class="icon">
                <ion-icon name="card-outline"></ion-icon>
              </span>
              <span class="title">Receitas</span>
            </a>
          </li>

          <li>
            <a href="Planos.html">
              <span class="icon">
                <ion-icon name="airplane-outline"></ion-icon>
              </span>
              <span class="title">Planos</span>
            </a>
          </li>

          <li>
            <a href="Poupanca.html">
              <span class="icon">
                <ion-icon name="wallet-outline"></ion-icon>
              </span>
              <span class="title">Poupan√ßa</span>
            </a>
          </li>

          <li>
            <a href="Investimentos.html">
              <span class="icon">
                <ion-icon name="trending-up-outline"></ion-icon>
              </span>
              <span class="title">Investimentos</span>
            </a>
          </li>

          <li>
            <a href="Configura√ß√µes.html">
              <span class="icon">
                <ion-icon name="settings-outline"></ion-icon>
              </span>
              <span class="title">Configura√ß√µes</span>
            </a>
          </li>

          <li>
            <a onclick="logout()">
              <span class="icon">
                <ion-icon name="log-out-outline"></ion-icon>
              </span>
              <span class="title">Sair</span>
            </a>
          </li>
        </ul>

        <!-- Informa√ß√£o do usu√°rio no rodap√© do sidebar -->
        <div class="user-sidebar-footer">
          <div class="user-info-display">
            <ion-icon name="person-circle-outline"></ion-icon>
            <span id="user-sidebar-name">Usu√°rio</span>
          </div>
        </div>
      </div>

      <!-- ========================= Principal ==================== -->
      <div class="main">
        <div class="topbar">
          <div class="toggle">
            <ion-icon name="menu-outline"></ion-icon>
          </div>

          <!-- Bot√£o AI Insights -->
          <div class="ai-insights-button" onclick="openAIInsights()">
            <ion-icon name="bulb-outline"></ion-icon>
            <span>AI Insights</span>
          </div>
        </div>

        <!-- ======================= Cart√µes ================== -->
        <div class="cardBox">
          <div class="card">
            <div>
              <div class="numbers">
                <p id="totalInvestimentosDisplay">R$ 0,00</p>
              </div>
              <div class="cardName">Total Investido</div>
            </div>
            <div class="iconBx">
              <ion-icon name="trending-up-outline"></ion-icon>
            </div>
          </div>

          <div class="card">
            <div>
              <div class="numbers">
                <p id="filteredInvestimentosDisplay">R$ 0,00</p>
              </div>
              <div class="cardName">Investimentos Filtrados</div>
            </div>
            <div class="iconBx">
              <ion-icon name="filter-outline"></ion-icon>
            </div>
          </div>
        </div>

        <!-- ================ Dashboard ================= -->
        <section id="transaction">
          <div class="details">
            <div class="recentOrders">
              <div class="cardHeader">
                <a onclick="Modal.open()" class="add-transaction-button"
                  >+ Adicionar Investimento</a
                >
                <a href="#" onclick="FilterModal.open()" class="btn1"
                  ><ion-icon name="filter-outline"></ion-icon> Filtrar</a
                >
              </div>

              <div class="table-container">
                <table id="data-table">
                  <thead>
                    <tr>
                      <th>Investimento</th>
                      <th>Tipo</th>
                      <th>Valor Investido</th>
                      <th>Valor Atual</th>
                      <th>Rentabilidade</th>
                      <th>Data</th>
                      <th>Editar</th>
                      <th>Excluir</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- Dados inseridos dinamicamente -->
                  </tbody>
                </table>
              </div>
              <div class="footOptions">
                <a href="#" onclick="filterClear()" class="btn1"
                  >Limpar Filtro</a
                >
              </div>
            </div>
          </div>
        </section>

        <!-- =========== Modal Adicionar (Padronizado) =========  -->
        <div class="standardized-modal-overlay">
          <div class="standardized-modal">
            <div class="standardized-modal-header">
              <h2>üìà Adicionar Investimento</h2>
              <button class="standardized-modal-close" onclick="Modal.close()">
                √ó
              </button>
            </div>

            <div class="standardized-modal-body">
              <form onsubmit="Form.submit(event)" id="form">
                <div class="standardized-input-group">
                  <label for="nome">Nome do Investimento</label>
                  <input
                    type="text"
                    id="nome"
                    name="nome"
                    placeholder="Ex: PETR4, Tesouro SELIC, CDB..."
                  />
                </div>

                <div class="standardized-input-group">
                  <label for="tipo">Tipo de Investimento</label>
                  <input
                    type="text"
                    id="tipo"
                    name="tipo"
                    placeholder="Ex: A√ß√£o, Tesouro Direto, CDB..."
                  />
                  <div class="predefined-categories">
                    <span class="category-tag" onclick="setTipoInvest('A√ß√£o')"
                      >ÔøΩ A√ß√£o</span
                    >
                    <span
                      class="category-tag"
                      onclick="setTipoInvest('Fundo Imobili√°rio')"
                      >üè¢ FII</span
                    >
                    <span class="category-tag" onclick="setTipoInvest('CDB')"
                      >üè¶ CDB</span
                    >
                    <span
                      class="category-tag"
                      onclick="setTipoInvest('Tesouro Direto')"
                      >üáßüá∑ Tesouro</span
                    >
                    <span class="category-tag" onclick="setTipoInvest('LCI')"
                      >üè° LCI</span
                    >
                    <span
                      class="category-tag"
                      onclick="setTipoInvest('Criptomoeda')"
                      >‚Çø Crypto</span
                    >
                  </div>
                </div>

                <div class="standardized-input-group">
                  <label for="valor_investido">Valor Investido (R$)</label>
                  <input
                    type="number"
                    id="valor_investido"
                    name="valor_investido"
                    placeholder="0,00"
                    step="0.01"
                  />
                </div>

                <div class="standardized-input-group">
                  <label for="valor_atual">Valor Atual (R$)</label>
                  <input
                    type="number"
                    id="valor_atual"
                    name="valor_atual"
                    placeholder="0,00 (opcional)"
                    step="0.01"
                  />
                </div>

                <div class="standardized-input-group">
                  <label for="data">Data da Aplica√ß√£o</label>
                  <input type="date" id="data" name="data" />
                </div>

                <div class="standardized-input-group">
                  <label for="corretora">Corretora/Institui√ß√£o</label>
                  <select id="corretora" name="corretora">
                    <option value="">Selecione a corretora</option>
                    <option value="xp">XP Investimentos</option>
                    <option value="btg">BTG Pactual</option>
                    <option value="inter">Inter</option>
                    <option value="rico">Rico</option>
                    <option value="clear">Clear</option>
                    <option value="nubank">Nubank</option>
                    <option value="itau">Ita√∫</option>
                    <option value="bradesco">Bradesco</option>
                    <option value="bb">Banco do Brasil</option>
                    <option value="outro">Outro</option>
                  </select>
                </div>

                <div class="standardized-modal-actions">
                  <a
                    onclick="Modal.close()"
                    class="standardized-button standardized-button-secondary"
                    >Cancelar</a
                  >
                  <button
                    type="submit"
                    class="standardized-button standardized-button-primary"
                  >
                    üíæ Salvar
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Toast personalizado removido - usando sistema toast padronizado -->

        <!-- =============================  Modal do Filtro (Padronizado) ============================-->
        <div class="standardized-modal-overlay filter-modal-overlay">
          <div class="standardized-modal">
            <div class="standardized-modal-header">
              <h2>üîç Filtrar Investimentos</h2>
              <button
                class="standardized-modal-close"
                onclick="FilterModal.close()"
              >
                √ó
              </button>
            </div>

            <div class="standardized-modal-body">
              <form id="filter-form" onsubmit="filterInvestimentos(event)">
                <div class="standardized-input-group">
                  <label for="filter-nome">Nome do Investimento</label>
                  <input
                    type="text"
                    id="filter-nome"
                    name="nome"
                    placeholder="Ex: PETR4, Tesouro... (busca parcial)"
                  />
                </div>

                <div class="standardized-input-group">
                  <label for="filter-tipo">Tipo</label>
                  <input
                    type="text"
                    id="filter-tipo"
                    name="tipo"
                    placeholder="Ex: A√ß√£o, Tesouro Direto, CDB..."
                  />
                </div>

                <div class="standardized-input-group">
                  <label for="filter-valor">Valor Investido (R$)</label>
                  <input
                    type="number"
                    id="filter-valor"
                    name="valor"
                    placeholder="Ex: 1000.00 (valor exato)"
                    step="0.01"
                  />
                </div>

                <div class="standardized-input-group">
                  <label for="filter-data">Data da Aplica√ß√£o</label>
                  <input type="date" id="filter-data" name="data" />
                </div>

                <div class="standardized-modal-actions">
                  <a
                    onclick="FilterModal.close()"
                    class="standardized-button standardized-button-secondary"
                    >Cancelar</a
                  >
                  <button
                    type="submit"
                    class="standardized-button standardized-button-primary"
                  >
                    üîç Filtrar
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- =========================== Modal de Editar (Padronizado) ============================-->
        <div class="standardized-modal-overlay edit-modal-overlay">
          <div class="standardized-modal">
            <div class="standardized-modal-header">
              <h2>‚úèÔ∏è Editar Investimento</h2>
              <button
                class="standardized-modal-close"
                onclick="closeEditModal()"
              >
                √ó
              </button>
            </div>

            <div class="standardized-modal-body">
              <form id="edit-form" onsubmit="submitEditForm(event)">
                <div class="standardized-input-group">
                  <label for="edit-nome">Nome do Investimento</label>
                  <input
                    type="text"
                    id="edit-nome"
                    name="nome"
                    placeholder="Nome do investimento"
                  />
                </div>

                <div class="standardized-input-group">
                  <label for="edit-tipo">Tipo</label>
                  <input
                    type="text"
                    id="edit-tipo"
                    name="tipo"
                    placeholder="Ex: A√ß√£o, Tesouro Direto, CDB..."
                  />
                  <div class="predefined-categories">
                    <span
                      class="category-tag"
                      onclick="setEditTipoInvest('A√ß√£o')"
                      >ÔøΩ A√ß√£o</span
                    >
                    <span
                      class="category-tag"
                      onclick="setEditTipoInvest('Fundo Imobili√°rio')"
                      >üè¢ FII</span
                    >
                    <span
                      class="category-tag"
                      onclick="setEditTipoInvest('CDB')"
                      >üè¶ CDB</span
                    >
                    <span
                      class="category-tag"
                      onclick="setEditTipoInvest('Tesouro Direto')"
                      >üáßüá∑ Tesouro</span
                    >
                    <span
                      class="category-tag"
                      onclick="setEditTipoInvest('LCI')"
                      >üè° LCI</span
                    >
                    <span
                      class="category-tag"
                      onclick="setEditTipoInvest('Criptomoeda')"
                      >‚Çø Crypto</span
                    >
                  </div>
                </div>

                <div class="standardized-input-group">
                  <label for="edit-valor-investido">Valor Investido (R$)</label>
                  <input
                    type="number"
                    id="edit-valor-investido"
                    name="valor_investido"
                    placeholder="0,00"
                    step="0.01"
                  />
                </div>

                <div class="standardized-input-group">
                  <label for="edit-valor-atual">Valor Atual (R$)</label>
                  <input
                    type="number"
                    id="edit-valor-atual"
                    name="valor_atual"
                    placeholder="0,00"
                    step="0.01"
                  />
                </div>

                <div class="standardized-input-group">
                  <label for="edit-date">Data da Aplica√ß√£o</label>
                  <input type="date" id="edit-date" name="date" />
                </div>

                <div class="standardized-modal-actions">
                  <a
                    onclick="closeEditModal()"
                    class="standardized-button standardized-button-secondary"
                    >Cancelar</a
                  >
                  <button
                    type="submit"
                    class="standardized-button standardized-button-primary"
                  >
                    üíæ Salvar
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ====== Scripts ======= -->
    <script
      type="module"
      src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"
    ></script>
    <script
      nomodule
      src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"
    ></script>

    <!-- Supabase SDK (UMD) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <!-- Supabase Initialization -->
    <script src="../controllers/supabase-init.env"></script>

    <script src="../controllers/main.js"></script>
    <script src="../controllers/toast-system.js"></script>

    <!-- Supabase Guard -->
    <script src="../controllers/supabase-guard.env"></script>

    <script src="../models/investimentos.js"></script>

    <script>
      // Logout functionality
      document
        .getElementById("logoutBtn")
        ?.addEventListener("click", async function () {
          if (window.supabase) {
            await window.supabase.auth.signOut();
          }
          window.location.href = "../views/Login.html";
        });
    </script>
  </body>
</html>
