<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayFly</title>
    <link rel="icon" type="image/png" href="../views/imgs/Favicon.png">
    
    <!-- ======= Estilos ====== -->
    <link rel="stylesheet" href="../views/css/style.css">
    <link rel="stylesheet" href="../views/css/data-tables.css">
    <link rel="stylesheet" href="../views/css/config-utils.css">
    <link rel="stylesheet" href="../assets/css/accessibility.css">
    
    <!-- For√ßar tema escuro nas tabelas -->
    <style>
        /* TEMA ESCURO - Container preto, tabela cinza */
        body:not(.light-theme) .table-container {
            background: #1a1a1a !important;
            background-color: #1a1a1a !important;
            border-radius: 10px !important;
            padding: 15px !important;
        }
        
        body:not(.light-theme) .table-container table,
        body:not(.light-theme) #data-table {
            background: #2a2a2a !important;
            background-color: #2a2a2a !important;
            border-radius: 8px !important;
        }
        
        body:not(.light-theme) .table-container tbody,
        body:not(.light-theme) #data-table tbody {
            background: #2a2a2a !important;
            background-color: #2a2a2a !important;
        }
        
        body:not(.light-theme) .table-container tbody tr,
        body:not(.light-theme) #data-table tbody tr,
        body:not(.light-theme) tbody tr[id^="row-"] {
            background: #2a2a2a !important;
            background-color: #2a2a2a !important;
            background-image: none !important;
        }
        
        body:not(.light-theme) .table-container tbody tr:hover,
        body:not(.light-theme) #data-table tbody tr:hover,
        body:not(.light-theme) tbody tr[id^="row-"]:hover {
            background: #3a3a3a !important;
            background-color: #3a3a3a !important;
        }
        
        body:not(.light-theme) .table-container tbody tr td,
        body:not(.light-theme) #data-table tbody tr td,
        body:not(.light-theme) tbody tr[id^="row-"] td {
            background: #2a2a2a !important;
            background-color: #2a2a2a !important;
            color: #e0e0e0 !important;
        }
        
        /* Tema claro */
        body.light-theme .table-container,
        body.light-theme .table-container table,
        body.light-theme .table-container tbody,
        body.light-theme .table-container tbody tr,
        body.light-theme .table-container tbody tr td {
            background: #ffffff !important;
            background-color: #ffffff !important;
        }
    </style>
    
    <!-- Sistema de estilos de tabela com MutationObserver -->
    <script>
        function applyRowStyles(row) {
            const isDarkTheme = !document.body.classList.contains('light-theme');
            if (isDarkTheme) {
                row.style.setProperty('background', '#2a2a2a', 'important');
                row.style.setProperty('background-color', '#2a2a2a', 'important');
                row.querySelectorAll('td').forEach(td => {
                    td.style.setProperty('background', '#2a2a2a', 'important');
                    td.style.setProperty('background-color', '#2a2a2a', 'important');
                });
            } else {
                row.style.setProperty('background', '#ffffff', 'important');
                row.style.setProperty('background-color', '#ffffff', 'important');
                row.querySelectorAll('td').forEach(td => {
                    td.style.setProperty('background', '#ffffff', 'important');
                    td.style.setProperty('background-color', '#ffffff', 'important');
                });
            }
        }
        
        function cleanTableStyles() {
            document.querySelectorAll('tbody tr').forEach(applyRowStyles);
        }
        
        // Observa mudan√ßas na tabela para aplicar estilos em novas linhas
        document.addEventListener('DOMContentLoaded', function() {
            const tbody = document.querySelector('#data-table tbody') || document.querySelector('tbody');
            if (tbody) {
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.nodeName === 'TR') {
                                applyRowStyles(node);
                            }
                        });
                    });
                });
                observer.observe(tbody, { childList: true });
            }
            // Aplica nos existentes tamb√©m
            setTimeout(cleanTableStyles, 100);
            setTimeout(cleanTableStyles, 500);
            setTimeout(cleanTableStyles, 1500);
        });

        document.addEventListener('themeChange', function() {
            cleanTableStyles();
            setTimeout(cleanTableStyles, 100);
        });
    </script>
</head>

<body class="light-theme">
    <!-- =============== Barra de Acessibilidade =============== -->
    <div class="accessibility-bar">
        <div class="accessibility-controls">
            <button class="accessibility-btn" id="decrease-font-btn" title="Diminuir fonte (Ctrl + -)">
                <ion-icon name="remove-outline"></ion-icon>
            </button>
            <span class="font-size-display" id="font-size-display">16px</span>
            <button class="accessibility-btn" id="increase-font-btn" title="Aumentar fonte (Ctrl + +)">
                <ion-icon name="add-outline"></ion-icon>
            </button>
            <button class="accessibility-btn" id="reset-font-btn" title="Resetar fonte (Ctrl + 0)">
                <ion-icon name="refresh-outline"></ion-icon>
            </button>
            <div class="accessibility-divider"></div>
            <button class="accessibility-btn" id="theme-toggle-btn" title="Alternar tema (Ctrl + Shift + T)">
                <ion-icon name="sunny-outline"></ion-icon>
            </button>
        </div>
    </div>

    <!-- =============== Menu Navega√ß√£o ================ -->
    <div class="container">
        <div class="navigation">
            <ul>
                <li>
                    <a href="#">
                        <span class="icon">
                            <img src="../views/imgs/logo.svg" alt="Logo">
                        </span>
                        <span class="title">PayFly</span>
                    </a>
                </li>

                <li>
                    <a href="Painel.html">
                        <span class="icon">
                            <ion-icon name="home-outline"></ion-icon>
                        </span>
                        <span class="title">Painel Principal</span>
                    </a>
                </li>

                <li>
                    <a href="Despesas.html">
                <li>
                    <a href="Receitas.html">
                        <span class="icon">
                            <ion-icon name="card-outline"></ion-icon>
                        </span>
                        <span class="title">Receitas</span>
                    </a>
                </li>

                <li>
                    <a href="Despesas.html">
                        <span class="icon">
                            <ion-icon name="cart-outline"></ion-icon>
                        </span>
                        <span class="title">Despesas</span>
                    </a>
                </li>

                <li>
                    <a href="Planos.html">
                        <span class="icon">
                            <ion-icon name="radio-button-on"></ion-icon>
                        </span>
                        <span class="title">Planos</span>
                    </a>
                </li>

                <li>
                    <a href="Poupanca.html">
                        <span class="icon">
                            <ion-icon name="wallet-outline"></ion-icon>
                        </span>
                        <span class="title">Poupan√ßa</span>
                    </a>
                </li>

                <li>
                    <a href="Investimentos.html">
                        <span class="icon">
                            <ion-icon name="trending-up-outline"></ion-icon>
                        </span>
                        <span class="title">Investimentos</span>
                    </a>
                </li>

                <li>
                    <a href="Configura√ß√µes.html">
                        <span class="icon">
                            <ion-icon name="settings-outline"></ion-icon>
                        </span>
                        <span class="title">Configura√ß√µes</span>
                    </a>
                </li>


                <li>
                    <a onclick="logout()">
                        <span class="icon">
                            <ion-icon name="log-out-outline"></ion-icon>
                        </span>
                        <span class="title">Sair</span>
                    </a>
                </li>
            </ul>
            
            <!-- Informa√ß√£o do usu√°rio no rodap√© do sidebar -->
            <div class="user-sidebar-footer">
                <div class="user-info-display">
                    <ion-icon name="person-circle-outline"></ion-icon>
                    <span id="user-sidebar-name">Usu√°rio</span>
                </div>
            </div>
        </div>

        <!-- ========================= Principal ==================== -->
        <div class="main">
            <div class="topbar">
                <div class="toggle">
                    <ion-icon name="menu-outline"></ion-icon>
                </div>

                <!-- Bot√£o AI Insights -->
                <div class="ai-insights-button" onclick="openAIInsights()">
                    <ion-icon name="bulb-outline"></ion-icon>
                    <span>AI Insights</span>
                </div>

                <!-- <div class="search">
                    <label>
                        <input type="text" placeholder="">
                        <ion-icon name=""></ion-icon>
                    </label>
                </div> -->
            </div>

            <!-- ======================= Cart√µes ================== -->
            <div class="cardBox">
                
                <div class="card">
                    <div>
                        <div class="numbers"><p id="totalDespesaDisplay">R$ 0,00</p></div>
                        <div class="cardName">Total Despesas</div>
                    </div>

                    <div class="iconBx">
                        <ion-icon name="cash-outline"></ion-icon>
                    </div>
                </div>                
            
            
                <!-- Novo cart√£o para exibir o valor das despesas filtradas -->
                <div class="card">
                    <div>
                        <div class="numbers"><p id="filteredDespesaDisplay">R$ 0,00</p></div>
                        <div class="cardName">Despesas Filtradas</div>
                    </div>
                    <div class="iconBx">
                        <ion-icon name="filter-outline"></ion-icon>
                    </div>
                </div>
            
            </div>

            <!-- ================ Dashboard ================= -->
            <section id="transaction">
            <div class="details" style="grid-template-columns: 1fr;">
                <div class="recentOrders">

                    <div class="cardHeader">
                        <a onclick="Modal.open()" class="add-transaction-button">+ Adicionar Despesa</a>
                        <a href="#" onclick="FilterModal.open()" class="btn1"><i class=" filter fas fa-sort-down"></i><ion-icon name="filter-outline"></ion-icon> Filtrar</a>
                        
                    </div>

                    <div class="table-container">
                        <table id='data-table'>
                            <thead>
                                <tr>
                                    <th>Descri√ß√£o</th>
                                    <th>Valor</th>
                                    <th>Data</th>
                                    <th>Categoria</th>
                                    <th>Recorrente</th>
                                    <th>Editar</th>
                                    <th>Excluir</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dados inseridos dinamicamente -->
                            </tbody>
                        </table>
                    </div>
                    <div class="footOptions">
                        <a href="#" onclick="filterClear()" class="btn1">Limpar Filtro</a>
                </div> 
            </section>

              <!-- =========== Modal Adicionar (Padronizado) =========  -->

    <div class="standardized-modal-overlay">
        <div class="standardized-modal">
            <div class="standardized-modal-header">
                <h2>üí∏ Adicionar Despesa</h2>
                <button class="standardized-modal-close" onclick="Modal.close()">√ó</button>
            </div>
            
            <div class="standardized-modal-body">
                <form onsubmit="Form.submit(event)" id="form">
                    <div class="standardized-input-group">
                        <label for="descricao">Descri√ß√£o</label>
                        <input type="text" id="descricao" name="descricao" placeholder="Ex: Aluguel, Mercado, Cart√£o de Cr√©dito...">
                    </div>

                    <div class="standardized-input-group">
                        <label for="valor">Valor (R$)</label>
                        <input type="number" id="valor" name="valor" placeholder="0,00" step="0.01">
                    </div>

                    <div class="standardized-help-text">Use o sinal (-) para saldos negativos.</div>

                    <div class="standardized-input-group">
                        <label for="data">Data</label>
                        <input type="date" id="data" name="data">
                    </div>

                    <div class="standardized-input-group categoria-group">
                        <label for="categoria">Categoria</label>
                        <div class="categoria-input-wrapper">
                            <input type="text" id="categoria" name="categoria" placeholder="Digite ou selecione uma categoria...">
                            <button type="button" class="ia-suggest-btn" onclick="suggestCategorySimple()" title="Sugest√£o com IA">
                                ü§ñ IA
                            </button>
                        </div>
                        <div class="categoria-suggestions" id="categoria-suggestions"></div>
                        <div class="predefined-categories">
                            <span class="category-tag" onclick="selectCategory('Alimenta√ß√£o')">Alimenta√ß√£o</span>
                            <span class="category-tag" onclick="selectCategory('Transporte')">Transporte</span>
                            <span class="category-tag" onclick="selectCategory('Moradia')">Moradia</span>
                            <span class="category-tag" onclick="selectCategory('Sa√∫de')">Sa√∫de</span>
                            <span class="category-tag" onclick="selectCategory('Educa√ß√£o')">Educa√ß√£o</span>
                            <span class="category-tag" onclick="selectCategory('Lazer')">Lazer</span>
                        </div>
                    </div>

                    <div class="standardized-input-group recorrencia-group">
                        <label for="is_recorrente" class="recorrencia-label">
                            <span class="recorrencia-text">Despesa Recorrente?</span>
                            <div class="switch-toggle">
                                <input type="checkbox" id="is_recorrente" name="is_recorrente" onchange="toggleRecorrenciaFields()">
                                <span class="slider"></span>
                            </div>
                        </label>
                    </div>

                    <div class="standardized-input-group" id="recorrencia_meses_group" style="display: none;">
                        <label for="recorrencia_meses">Dura√ß√£o (meses)</label>
                        <input type="number" id="recorrencia_meses" name="recorrencia_meses" placeholder="Ex: 6, 12..." min="1" max="120" value="1">
                        <div class="standardized-help-text">A despesa ser√° replicada a cada m√™s at√© o prazo especificado, no mesmo dia da data informada.</div>
                    </div>

                    <div class="standardized-modal-actions">
                        <a onclick="Modal.close()" class="standardized-button standardized-button-secondary">Cancelar</a>
                        <button type="submit" class="standardized-button standardized-button-primary">üíæ Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div id="toast">
        <div class="img"><h1>√ó</h1></div>
        <div class="description">Por favor, preencha todos os campos!</div>
    </div>

    <!-- =============================  Modal do Filtro (Padronizado) ============================-->

<div class="standardized-modal-overlay filter-modal-overlay">
    <div class="standardized-modal">
        <div class="standardized-modal-header">
            <h2>üîç Filtrar Despesas</h2>
            <button class="standardized-modal-close" onclick="FilterModal.close()">√ó</button>
        </div>
        
        <div class="standardized-modal-body">
            <form id="filter-form" onsubmit="filterDespesas(event)">
                <div class="standardized-input-group">
                    <label for="filter-descricao">Descri√ß√£o</label>
                    <input type="text" id="filter-descricao" name="descricao" placeholder="Ex: Nubank, Mercado... (busca parcial)">
                </div>

                <div class="standardized-input-group">
                    <label for="filter-valor">Valor (R$)</label>
                    <input type="number" id="filter-valor" name="valor" placeholder="Ex: 150.50 (valor exato)" step="0.01">
                </div>

                <div class="standardized-input-group">
                    <label for="filter-data">Data</label>
                    <input type="date" id="filter-data" name="data">
                </div>

                <div class="standardized-input-group">
                    <label for="filter-categoria">Categoria</label>
                    <input type="text" id="filter-categoria" name="categoria" placeholder="Ex: Alimenta√ß√£o, Transporte... (busca parcial)">
                    <div class="predefined-categories filter-categories">
                        <span class="category-tag" onclick="selectFilterCategory('Alimenta√ß√£o')">Alimenta√ß√£o</span>
                        <span class="category-tag" onclick="selectFilterCategory('Transporte')">Transporte</span>
                        <span class="category-tag" onclick="selectFilterCategory('Moradia')">Moradia</span>
                        <span class="category-tag" onclick="selectFilterCategory('Sa√∫de')">Sa√∫de</span>
                        <span class="category-tag" onclick="selectFilterCategory('Educa√ß√£o')">Educa√ß√£o</span>
                        <span class="category-tag" onclick="selectFilterCategory('Lazer')">Lazer</span>
                    </div>
                </div>

                <div class="standardized-input-group">
                    <label for="filter-recorrente">Filtrar por Recorr√™ncia</label>
                    <select id="filter-recorrente" name="recorrente">
                        <option value="">Todas</option>
                        <option value="sim">Apenas Recorrentes</option>
                        <option value="nao">Apenas √önicas</option>
                    </select>
                </div>

                <div class="standardized-modal-actions">
                    <a onclick="FilterModal.close()" class="standardized-button standardized-button-secondary">Cancelar</a>
                    <button type="submit" class="standardized-button standardized-button-primary">üîç Filtrar</button>
                </div>
            </form>
        </div>
    </div>
</div>

    <!-- =========================== Modal de Editar (Padronizado) ============================-->

<div class="standardized-modal-overlay edit-modal-overlay">
    <div class="standardized-modal">
        <div class="standardized-modal-header">
            <h2>‚úèÔ∏è Editar Despesa</h2>
            <button class="standardized-modal-close" onclick="closeEditModal()">√ó</button>
        </div>
        
        <div class="standardized-modal-body">
            <form id="edit-form" onsubmit="submitEditForm(event)">
                <div class="standardized-input-group">
                    <label for="edit-description">Descri√ß√£o</label>
                    <input type="text" id="edit-description" name="description" placeholder="Descri√ß√£o da despesa">
                </div>

                <div class="standardized-input-group">
                    <label for="edit-amount">Valor (R$)</label>
                    <input type="number" id="edit-amount" name="amount" placeholder="0,00" step="0.01">
                </div>

                <div class="standardized-help-text">Use o sinal (-) para saldos negativos.</div>

                <div class="standardized-input-group">
                    <label for="edit-date">Data</label>
                    <input type="date" id="edit-date" name="date">
                </div>

                <div class="standardized-input-group categoria-group">
                    <label for="edit-categoria">Categoria</label>
                    <input type="text" id="edit-categoria" name="categoria" placeholder="Digite ou selecione uma categoria...">
                </div>

                <div class="standardized-input-group recorrencia-group">
                    <label for="edit-is-recorrente" class="recorrencia-label">
                        <span class="recorrencia-text">Despesa Recorrente?</span>
                        <div class="switch-toggle">
                            <input type="checkbox" id="edit-is-recorrente" name="is_recorrente" onchange="toggleEditRecorrenciaFields()">
                            <span class="slider"></span>
                        </div>
                    </label>
                </div>

                <div class="standardized-input-group" id="edit-recorrencia-meses-group" style="display: none;">
                    <label for="edit-recorrencia-meses">Dura√ß√£o (meses)</label>
                    <input type="number" id="edit-recorrencia-meses" name="recorrencia_meses" placeholder="Ex: 6, 12..." min="1" max="120" value="1">
                    <div class="standardized-help-text">A despesa ser√° replicada a cada m√™s at√© o prazo especificado.</div>
                </div>

                <div class="standardized-modal-actions">
                    <a onclick="closeEditModal()" class="standardized-button standardized-button-secondary">Cancelar</a>
                    <button type="submit" class="standardized-button standardized-button-primary">üíæ Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>

    <!-- ================ Modal Boleto (Padronizado) ================= -->
    <div class="standardized-modal-overlay" id="boleto-modal">
        <div class="standardized-modal">
            <div class="standardized-modal-header">
                <h2>üßæ Boleto Banc√°rio Gerado</h2>
                <button class="standardized-modal-close" onclick="BoletoModal.close()">√ó</button>
            </div>
            
            <div class="standardized-modal-body">
                <div class="standardized-info-box">
                    <h3 class="boleto-info">üìã Informa√ß√µes do Boleto</h3>
                    <ul class="standardized-list">
                        <li><strong>Benefici√°rio:</strong> <span id="boleto-beneficiario"></span></li>
                        <li><strong>Valor:</strong> R$ <span id="boleto-valor"></span></li>
                        <li><strong>Vencimento:</strong> <span id="boleto-vencimento"></span></li>
                        <li><strong>Nosso N√∫mero:</strong> <span id="boleto-nosso-numero"></span></li>
                        <li><strong>Descri√ß√£o:</strong> <span id="boleto-descricao"></span></li>
                    </ul>
                </div>
                
                <div class="standardized-warning-box">
                    <h4>üìä C√≥digo de Barras:</h4>
                    <div id="boleto-barcode" class="boleto-barcode"></div>
                </div>
                
                <div class="standardized-input-group">
                    <label for="linha-digitavel">Linha Digit√°vel:</label>
                    <input type="text" id="linha-digitavel" readonly class="linha-digitavel">
                </div>

                <div class="standardized-modal-actions">
                    <button type="button" onclick="copyLinhaDigitavel()" class="standardized-button standardized-button-secondary">üìã Copiar Linha</button>
                    <button type="button" onclick="printBoleto()" class="standardized-button standardized-button-secondary">üñ®Ô∏è Imprimir</button>
                    <a onclick="BoletoModal.close()" class="standardized-button standardized-button-primary">Fechar</a>
                </div>
            </div>
        </div>
    </div>

    <!-- =============== Modal AI Insights ================= -->
    <div class="ai-modal-overlay" id="aiInsightsModal">
        <div class="ai-modal">
            <div class="ai-modal-header">
                <h2>
                    <ion-icon name="bulb"></ion-icon>
                    AI Insights Financeiros
                </h2>
                <button class="ai-modal-close" onclick="closeAIInsights()">
                    <ion-icon name="close"></ion-icon>
                </button>
            </div>
            
            <div class="ai-chat-container">
                <div class="ai-chat-messages" id="aiChatMessages">
                    <div class="ai-welcome-message">
                        <ion-icon name="robot-outline"></ion-icon>
                        <div class="message-content">
                            <p>Ol√°! üëã Sou seu assistente financeiro com IA.</p>
                            <p>Posso analisar seus dados e responder perguntas como:</p>
                            <ul>
                                <li>"Como est√£o meus gastos este m√™s?"</li>
                                <li>"Vou conseguir alcan√ßar meus planos?"</li>
                                <li>"Onde posso economizar mais?"</li>
                            </ul>
                            <p>O que voc√™ gostaria de saber? ü§î</p>
                        </div>
                    </div>
                </div>
                
                <div class="ai-quick-questions">
                    <div class="quick-question-btn" onclick="askQuickQuestion('Como est√£o meus gastos este m√™s?')">
                        Como est√£o meus gastos?
                    </div>
                    <div class="quick-question-btn" onclick="askQuickQuestion('Onde posso economizar mais dinheiro?')">
                        Onde posso economizar?
                    </div>
                    <div class="quick-question-btn" onclick="askQuickQuestion('Como est√£o meus planos de economia?')">
                        Status dos meus planos
                    </div>
                </div>
                
                <div class="ai-chat-input">
                    <input type="text" id="aiChatInput" placeholder="Digite sua pergunta sobre finan√ßas..." maxlength="200">
                    <button onclick="sendAIMessage()" id="aiSendBtn">
                        <ion-icon name="send"></ion-icon>
                    </button>
                </div>
            </div>
            
            <div class="ai-loading" id="aiLoading">
                <div class="loading-spinner"></div>
                <span>Analisando seus dados...</span>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o de Exclus√£o -->
    <div class="delete-confirm-modal-overlay" id="deleteConfirmModal">
        <div class="delete-confirm-modal">
            <h3>
                <ion-icon name="warning-outline"></ion-icon>
                Confirmar Exclus√£o
            </h3>
            <p>Tem certeza que deseja excluir este item? Esta a√ß√£o n√£o pode ser desfeita.</p>
            <div class="delete-confirm-actions">
                <button class="delete-cancel-btn" onclick="closeDeleteConfirm()">Cancelar</button>
                <button class="delete-confirm-btn" onclick="confirmDelete()">Excluir</button>
            </div>
        </div>
    </div>

    <!-- =========== Scripts =========  -->

    <!-- Barcode Library for Boletos -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    
    <!-- Sistema de Toast Global -->
    <script src="../controllers/toast-system.js"></script>
    
    <!-- Supabase SDK (UMD) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

    <script src="../controllers/supabase-init.env"></script>
    
    <script src="../controllers/main.js"></script>
    <script src="../models/despesa.js" ></script>

    <!-- AI Insights Scripts -->
    <script src="../ai-insights/ai-service.js"></script>
    <script src="../ai-insights/data-analyzer.js"></script>
    <script src="../ai-insights/smart-categorization.js"></script>
    <script src="../ai-insights/categorization-ui.js"></script>
    <script src="../ai-insights/chat-interface.js"></script>

    <script src="../controllers/supabase-guard.env"></script>

    <!-- ====== ionicons ======= -->
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>

    <!-- Tratamento silencioso de erros -->
    <script>
        // Tratamento global de erros - Ultra Silencioso
        window.addEventListener('error', function(e) {
            const errorMsg = e.message || '';
            const isNonCritical = errorMsg.includes('Failed to fetch') || 
                                 errorMsg.includes('CORS') ||
                                 errorMsg.includes('ionicons') ||
                                 errorMsg.includes('net::ERR_FAILED') ||
                                 (e.filename && e.filename.includes('ionicons'));
            
            if (isNonCritical) {
                e.preventDefault();
                return true;
            }
            return false;
        });

        window.addEventListener('unhandledrejection', function(e) {
            const reason = e.reason?.message || e.reason || '';
            const isNonCritical = reason.includes('Failed to fetch') || 
                                  reason.includes('Load failed') ||
                                  reason.includes('net::ERR_FAILED') ||
                                  reason.includes('CORS') ||
                                  reason.includes('ionicons') ||
                                  reason.includes('Ionicon SVG blocked') ||
                                  reason.includes('Access-Control-Allow-Origin');
            
            if (isNonCritical) {
                e.preventDefault();
                return;
            }
        });
    </script>

        <script>
                async function logout () {
            if (window.supabase) {
                await window.supabase.auth.signOut();
            }
            window.location.replace("../index.html");
        }

        // Fun√ß√£o para selecionar categoria no filtro
        function selectFilterCategory(categoryName) {
            const filterCategoryInput = document.getElementById('filter-categoria');
            if (filterCategoryInput) {
                filterCategoryInput.value = categoryName;
                
                // Atualiza visualmente as tags
                const tags = document.querySelectorAll('.filter-categories .category-tag');
                tags.forEach(tag => {
                    tag.classList.remove('selected');
                    if (tag.textContent.trim() === categoryName) {
                        tag.classList.add('selected');
                    }
                });
            }
        }

        // Fun√ß√£o de fallback para sele√ß√£o de categoria no modal de adicionar
        function selectCategoryFallback(categoryName) {
            const categoryInput = document.querySelector('#categoria, input[name="categoria"]');
            if (categoryInput) {
                categoryInput.value = categoryName;
                
                // Atualiza visualmente as tags do modal
                const tags = document.querySelectorAll('.predefined-categories .category-tag');
                tags.forEach(tag => {
                    tag.classList.remove('selected');
                    if (tag.textContent.trim() === categoryName) {
                        tag.classList.add('selected');
                    }
                });
                
                // Trigger evento de mudan√ßa
                categoryInput.dispatchEvent(new Event('change'));
                categoryInput.dispatchEvent(new Event('input'));
                
                console.log('Categoria selecionada:', categoryName);
            }
        }

        // Fun√ß√£o de fallback para sugest√£o de IA
        async function suggestCategoryFallback(type) {
            // Se CategorizationUI est√° dispon√≠vel, usa ela
            if (window.CategorizationUI && typeof window.CategorizationUI.suggestCategory === 'function') {
                return await window.CategorizationUI.suggestCategory(type);
            }
            
            // Sen√£o, mostra uma mensagem
            const descricaoInput = document.querySelector('input[name="descricao"]');
            if (!descricaoInput || !descricaoInput.value.trim()) {
                notifyToast('Sugest√£o de categoria', 'Digite uma descri√ß√£o primeiro para usar a IA.', 'warning');
                return;
            }
            
            notifyToast('Sugest√£o de categoria', 'Sistema de IA carregando... Tente novamente em alguns segundos.', 'info');
        }

        // Garante que as fun√ß√µes est√£o dispon√≠veis globalmente
        window.selectCategoryFallback = selectCategoryFallback;
        window.suggestCategoryFallback = suggestCategoryFallback;

        // Fun√ß√£o SIMPLES para selecionar categoria - SEMPRE FUNCIONA
        function selectCategory(categoryName) {
            try {
                console.log('üè∑Ô∏è Selecionando categoria:', categoryName);
                
                if (!categoryName || categoryName.trim() === '') {
                    console.warn('‚ö†Ô∏è Nome da categoria vazio');
                    return false;
                }
                
                // Busca o campo de categoria no modal
                const categoryInput = document.querySelector('#categoria');
                const categoryInputByName = document.querySelector('input[name="categoria"]');
                const targetInput = categoryInput || categoryInputByName;
                
                if (targetInput) {
                    targetInput.value = categoryName.trim();
                    console.log('‚úÖ Categoria definida:', categoryName);
                    
                    // Remove sele√ß√£o de outras tags
                    const allTags = document.querySelectorAll('.predefined-categories .category-tag');
                    allTags.forEach(tag => {
                        if (tag) {
                            tag.classList.remove('selected');
                            tag.style.backgroundColor = '';
                            tag.style.color = '';
                        }
                    });
                    
                    // Destaca a tag selecionada
                    const clickedTags = Array.from(allTags).filter(tag => 
                        tag && tag.textContent && tag.textContent.trim() === categoryName.trim()
                    );
                    clickedTags.forEach(tag => {
                        if (tag) {
                            tag.classList.add('selected');
                            tag.style.backgroundColor = '#2a2185';
                            tag.style.color = 'white';
                        }
                    });
                    
                    // Dispara eventos para compatibilidade
                    try {
                        targetInput.dispatchEvent(new Event('change', { bubbles: true }));
                        targetInput.dispatchEvent(new Event('input', { bubbles: true }));
                    } catch (eventError) {
                        console.warn('‚ö†Ô∏è Erro ao disparar eventos:', eventError);
                    }
                    
                    console.log('‚úÖ Categoria selecionada com sucesso!');
                    return true;
                } else {
                    console.error('‚ùå Campo de categoria n√£o encontrado!');
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Erro ao selecionar categoria:', error);
                return false;
            }
        }

        // Fun√ß√£o SIMPLES para sugest√£o de IA - SEM RETORNO PARA EVITAR UNDEFINED
        async function suggestCategoryAI(type) {
            console.log('ü§ñ Solicitando sugest√£o de IA para:', type);
            
            // Busca descri√ß√£o
            const descInput = document.querySelector('#descricao');
            const descInputByName = document.querySelector('input[name="descricao"]');
            const descricaoField = descInput || descInputByName;
            
            if (!descricaoField || !descricaoField.value || !descricaoField.value.trim()) {
                notifyToast('Sugest√£o de categoria', 'Digite uma descri√ß√£o primeiro para a IA sugerir uma categoria.', 'warning');
                if (descricaoField) descricaoField.focus();
                return; // SEM VALOR DE RETORNO
            }
            
            const iaBtn = document.querySelector('.ia-suggest-btn');
            let originalText = 'ü§ñ IA';
            
            if (iaBtn) {
                originalText = iaBtn.innerHTML;
                iaBtn.innerHTML = '‚è≥ IA';
                iaBtn.disabled = true;
            }
            
            try {
                // Tenta usar CategorizationUI se dispon√≠vel
                if (window.CategorizationUI && typeof window.CategorizationUI.suggestCategory === 'function') {
                    await window.CategorizationUI.suggestCategory(type);
                    console.log('ü§ñ CategorizationUI executada com sucesso');
                } else {
                    // Sugest√µes simples baseadas em palavras-chave
                    const descricao = descricaoField.value.toLowerCase().trim();
                    let suggestedCategory = 'Outros';
                    
                    console.log('üîç Analisando descri√ß√£o:', descricao);
                    
                    if (descricao.includes('comida') || descricao.includes('restaurante') || descricao.includes('almo√ßo') || descricao.includes('jantar') || descricao.includes('lanche') || descricao.includes('pizza') || descricao.includes('hamburguer')) {
                        suggestedCategory = 'Alimenta√ß√£o';
                    } else if (descricao.includes('uber') || descricao.includes('bus') || descricao.includes('metro') || descricao.includes('gasolina') || descricao.includes('combust√≠vel') || descricao.includes('posto') || descricao.includes('√¥nibus') || descricao.includes('taxi')) {
                        suggestedCategory = 'Transporte';
                    } else if (descricao.includes('casa') || descricao.includes('aluguel') || descricao.includes('condom√≠nio') || descricao.includes('im√≥vel') || descricao.includes('moradia')) {
                        suggestedCategory = 'Moradia';
                    } else if (descricao.includes('m√©dico') || descricao.includes('farm√°cia') || descricao.includes('hospital') || descricao.includes('rem√©dio') || descricao.includes('consulta') || descricao.includes('exame')) {
                        suggestedCategory = 'Sa√∫de';
                    } else if (descricao.includes('curso') || descricao.includes('livro') || descricao.includes('escola') || descricao.includes('faculdade') || descricao.includes('material escolar') || descricao.includes('aula')) {
                        suggestedCategory = 'Educa√ß√£o';
                    } else if (descricao.includes('cinema') || descricao.includes('jogo') || descricao.includes('divers√£o') || descricao.includes('entretenimento') || descricao.includes('show') || descricao.includes('festa')) {
                        suggestedCategory = 'Lazer';
                    }
                    
                    console.log('ü§ñ IA analisou e sugeriu categoria:', suggestedCategory);
                    
                    // Aplica a categoria diretamente
                    const categoryInput = document.querySelector('#categoria');
                    if (categoryInput) {
                        categoryInput.value = suggestedCategory;
                        
                        // Destaca visualmente
                        const allTags = document.querySelectorAll('.predefined-categories .category-tag');
                        allTags.forEach(tag => {
                            tag.style.backgroundColor = '';
                            tag.style.color = '';
                        });
                        
                        const matchingTag = Array.from(allTags).find(tag => 
                            tag.textContent.trim() === suggestedCategory
                        );
                        if (matchingTag) {
                            matchingTag.style.backgroundColor = '#2a2185';
                            matchingTag.style.color = 'white';
                        }
                        
                        console.log('‚úÖ Categoria aplicada com sucesso:', suggestedCategory);
                    } else {
                        console.error('‚ùå Campo de categoria n√£o encontrado!');
                    }
                }
            } catch (error) {
                console.error('‚ùå Erro na sugest√£o de IA:', error);
                notifyToast('Sugest√£o de categoria', 'Sistema de IA temporariamente indispon√≠vel. Selecione uma categoria manualmente.', 'error');
            } finally {
                // Restaura bot√£o
                if (iaBtn) {
                    iaBtn.innerHTML = originalText;
                    iaBtn.disabled = false;
                }
            }
        }

        // Fun√ß√£o SUPER SIMPLES para IA - GARANTIDA PARA FUNCIONAR
        function suggestCategorySimple() {
            console.log('ü§ñ FUN√á√ÉO IA SIMPLES CHAMADA');
            
            // Pega a descri√ß√£o
            const descricaoInput = document.querySelector('#descricao');
            if (!descricaoInput || !descricaoInput.value.trim()) {
                notifyToast('Sugest√£o de categoria', 'Digite uma descri√ß√£o primeiro para que a IA sugira uma categoria.', 'warning');
                return;
            }
            
            const descricao = descricaoInput.value.toLowerCase();
            console.log('üìù Descri√ß√£o encontrada:', descricao);
            
            let categoria = 'Outros';
            
            // An√°lise simples
            if (descricao.includes('gasolina') || descricao.includes('posto') || descricao.includes('combust√≠vel')) {
                categoria = 'Transporte';
            } else if (descricao.includes('uber') || descricao.includes('taxi') || descricao.includes('√¥nibus')) {
                categoria = 'Transporte';
            } else if (descricao.includes('comida') || descricao.includes('restaurante') || descricao.includes('lanche')) {
                categoria = 'Alimenta√ß√£o';
            } else if (descricao.includes('rem√©dio') || descricao.includes('farm√°cia') || descricao.includes('m√©dico')) {
                categoria = 'Sa√∫de';
            } else if (descricao.includes('aluguel') || descricao.includes('casa') || descricao.includes('condom√≠nio')) {
                categoria = 'Moradia';
            } else if (descricao.includes('curso') || descricao.includes('livro') || descricao.includes('escola')) {
                categoria = 'Educa√ß√£o';
            } else if (descricao.includes('cinema') || descricao.includes('jogo') || descricao.includes('divers√£o')) {
                categoria = 'Lazer';
            }
            
            console.log('üéØ Categoria sugerida:', categoria);
            
            // Aplica a categoria
            const categoriaInput = document.querySelector('#categoria');
            if (categoriaInput) {
                categoriaInput.value = categoria;
                console.log('‚úÖ Categoria aplicada no campo:', categoria);
                
                // Destaca o bot√£o visualmente
                const botoes = document.querySelectorAll('.category-tag');
                botoes.forEach(btn => {
                    btn.style.backgroundColor = '';
                    btn.style.color = '';
                    if (btn.textContent.trim() === categoria) {
                        btn.style.backgroundColor = '#2a2185';
                        btn.style.color = 'white';
                        console.log('‚úÖ Bot√£o destacado:', categoria);
                    }
                });
            } else {
                console.error('‚ùå Campo categoria n√£o encontrado');
            }
        }

        // Garante que as fun√ß√µes est√£o dispon√≠veis globalmente
        window.selectCategory = selectCategory;
        window.suggestCategoryAI = suggestCategoryAI;
        window.suggestCategorySimple = suggestCategorySimple;
        
        // Fun√ß√£o para toggle de campos de recorr√™ncia
        function toggleRecorrenciaFields() {
            const isRecorrente = document.getElementById('is_recorrente').checked;
            const mesesGroup = document.getElementById('recorrencia_meses_group');
            
            if (isRecorrente) {
                mesesGroup.style.display = 'block';
                // Define valor padr√£o se n√£o houver
                const mesesInput = document.getElementById('recorrencia_meses');
                if (!mesesInput.value || mesesInput.value === '1') {
                    mesesInput.value = '1';
                }
            } else {
                mesesGroup.style.display = 'none';
                document.getElementById('recorrencia_meses').value = '1';
            }
        }
        
        // Disponibilizar fun√ß√µes globalmente
        window.toggleRecorrenciaFields = toggleRecorrenciaFields;
        window.toggleEditRecorrenciaFields = toggleEditRecorrenciaFields;
        
        // Debug: Verifica se as fun√ß√µes foram definidas corretamente
        console.log('üîç Debug - Verificando fun√ß√µes:');
        console.log('selectCategory:', typeof window.selectCategory);
        console.log('suggestCategoryAI:', typeof window.suggestCategoryAI);
        console.log('suggestCategorySimple:', typeof window.suggestCategorySimple);
        console.log('toggleRecorrenciaFields:', typeof window.toggleRecorrenciaFields);
        console.log('toggleEditRecorrenciaFields:', typeof window.toggleEditRecorrenciaFields);
        
        // Fun√ß√£o de teste para debug
        window.testCategoryFunction = function() {
            console.log('üß™ Testando selectCategory...');
            const result = selectCategory('Teste');
            console.log('üß™ Resultado do teste:', result);
            return result;
        };
        
        // Teste da fun√ß√£o simples
        window.testSimpleIA = function() {
            console.log('üß™ Testando IA simples...');
            // Simula ter uma descri√ß√£o
            const desc = document.querySelector('#descricao');
            if (desc) {
                desc.value = 'gasolina';
                suggestCategorySimple();
            }
        };

        // Aguarda o carregamento e configura fallbacks se necess√°rio
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ DOM carregado - configurando categorias...');
            
            // Aguarda um pouco para CategorizationUI carregar
            setTimeout(() => {
                // Se CategorizationUI n√£o estiver dispon√≠vel, configura fallbacks
                if (!window.CategorizationUI || typeof window.CategorizationUI.selectCategory !== 'function') {
                    console.warn('CategorizationUI n√£o dispon√≠vel, usando fun√ß√µes fallback');
                    window.CategorizationUI = {
                        selectCategory: selectCategory,
                        suggestCategory: suggestCategoryAI
                    };
                }
                
                console.log('‚úÖ Sistema de categorias configurado!');
            }, 1000);
        });
        </script>
    
    <!-- ====== Injetor de Acessibilidade ======= -->
    <script src="../controllers/accessibility-injector.js"></script>
    
    <!-- ====== Sistema de Acessibilidade ======= -->
    <script src="../controllers/accessibility.js"></script>
</body>

</html>
