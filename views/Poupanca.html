<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PayFly - Poupança</title>
    <link rel="icon" type="image/png" href="../view/imgs/Favicon.png" />

    <!-- ======= Estilos ====== -->
    <link rel="stylesheet" href="../views/css/style.css" />
    <link rel="stylesheet" href="../views/css/data-tables.css" />

    <!-- Script ULTRA AGRESSIVO para forçar estilos -->
    <script>
      // Sistema único de limpeza - SEM LOOPS
      let tableStylesFixed = false;

      function cleanTableStyles() {
        if (tableStylesFixed) return; // Executa apenas UMA vez

        console.debug("🧹 Limpando estilos de tabela...");

        // Remove backgrounds apenas das linhas de dados (tbody tr)
        const dataRows = document.querySelectorAll("tbody tr");
        dataRows.forEach((row) => {
          row.style.setProperty("background", "#ffffff", "important");
          row.style.setProperty("background-image", "none", "important");
        });

        // Marca como concluído
        tableStylesFixed = true;
        console.debug("✅ Estilos limpos");
      }

      // Executa apenas uma vez após DOM carregar
      document.addEventListener("DOMContentLoaded", function () {
        setTimeout(cleanTableStyles, 500); // Aguarda carregamento completo
      });
    </script>
  </head>

  <body>
    <!-- =============== Menu Navegação ================ -->
    <div class="container">
      <div class="navigation">
        <ul>
          <li>
            <a href="#">
              <span class="icon">
                <img src="../views/imgs/logo.svg" alt="Logo" />
              </span>
              <span class="title">PayFly</span>
            </a>
          </li>

          <li>
            <a href="Painel.html">
              <span class="icon">
                <ion-icon name="home-outline"></ion-icon>
              </span>
              <span class="title">Painel Principal</span>
            </a>
          </li>

          <li>
            <a href="Despesas.html">
              <span class="icon">
                <ion-icon name="cart-outline"></ion-icon>
              </span>
              <span class="title">Despesas</span>
            </a>
          </li>

          <li>
            <a href="Receitas.html">
              <span class="icon">
                <ion-icon name="card-outline"></ion-icon>
              </span>
              <span class="title">Receitas</span>
            </a>
          </li>

          <li>
            <a href="Planos.html">
              <span class="icon">
                <ion-icon name="airplane-outline"></ion-icon>
              </span>
              <span class="title">Planos</span>
            </a>
          </li>

          <li>
            <a href="Poupanca.html">
              <span class="icon">
                <ion-icon name="wallet-outline"></ion-icon>
              </span>
              <span class="title">Poupança</span>
            </a>
          </li>

          <li>
            <a href="Investimentos.html">
              <span class="icon">
                <ion-icon name="trending-up-outline"></ion-icon>
              </span>
              <span class="title">Investimentos</span>
            </a>
          </li>

          <li>
            <a href="Configurações.html">
              <span class="icon">
                <ion-icon name="settings-outline"></ion-icon>
              </span>
              <span class="title">Configurações</span>
            </a>
          </li>

          <li>
            <a onclick="logout()">
              <span class="icon">
                <ion-icon name="log-out-outline"></ion-icon>
              </span>
              <span class="title">Sair</span>
            </a>
          </li>
        </ul>

        <!-- Informação do usuário no rodapé do sidebar -->
        <div class="user-sidebar-footer">
          <div class="user-info-display">
            <ion-icon name="person-circle-outline"></ion-icon>
            <span id="user-sidebar-name">Usuário</span>
          </div>
        </div>
      </div>

      <!-- ========================= Principal ==================== -->
      <div class="main">
        <div class="topbar">
          <div class="toggle">
            <ion-icon name="menu-outline"></ion-icon>
          </div>

          <!-- Botão AI Insights -->
          <div class="ai-insights-button" onclick="openAIInsights()">
            <ion-icon name="bulb-outline"></ion-icon>
            <span>AI Insights</span>
          </div>
        </div>

        <!-- ======================= Cartões ================== -->
        <div class="cardBox">
          <div class="card">
            <div>
              <div class="numbers">
                <p id="totalPoupancaDisplay">R$ 0,00</p>
              </div>
              <div class="cardName">Total Poupado</div>
            </div>
            <div class="iconBx">
              <ion-icon name="wallet-outline"></ion-icon>
            </div>
          </div>

          <div class="card">
            <div>
              <div class="numbers">
                <p id="filteredPoupancaDisplay">R$ 0,00</p>
              </div>
              <div class="cardName">Poupança Filtrada</div>
            </div>
            <div class="iconBx">
              <ion-icon name="filter-outline"></ion-icon>
            </div>
          </div>
        </div>

        <!-- ================ Dashboard ================= -->
        <section id="transaction">
          <div class="details">
            <div class="recentOrders">
              <div class="cardHeader">
                <a onclick="Modal.open()" class="add-transaction-button"
                  >+ Adicionar Poupança</a
                >
                <a href="#" onclick="FilterModal.open()" class="btn1"
                  ><ion-icon name="filter-outline"></ion-icon> Filtrar</a
                >
              </div>

              <div class="table-container">
                <table id="data-table">
                  <thead>
                    <tr>
                      <th>Descrição</th>
                      <th>Valor</th>
                      <th>Data</th>
                      <th>Tipo</th>
                      <th>Plano</th>
                      <th>Editar</th>
                      <th>Excluir</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- Dados inseridos dinamicamente -->
                  </tbody>
                </table>
              </div>
              <div class="footOptions">
                <a href="#" onclick="filterClear()" class="btn1"
                  >Limpar Filtro</a
                >
              </div>
            </div>
          </div>
        </section>

        <!-- =========== Modal Adicionar (Padronizado) =========  -->
        <div class="standardized-modal-overlay">
          <div class="standardized-modal">
            <div class="standardized-modal-header">
              <h2>💰 Adicionar à Poupança</h2>
              <button class="standardized-modal-close" onclick="Modal.close()">
                ×
              </button>
            </div>

            <div class="standardized-modal-body">
              <form onsubmit="Form.submit(event)" id="form">
                <div class="standardized-input-group">
                  <label for="descricao">Descrição</label>
                  <input
                    type="text"
                    id="descricao"
                    name="descricao"
                    placeholder="Ex: Depósito mensal, Rendimento..."
                  />
                </div>

                <div class="standardized-input-group">
                  <label for="valor">Valor (R$)</label>
                  <input
                    type="number"
                    id="valor"
                    name="valor"
                    placeholder="0,00"
                    step="0.01"
                  />
                </div>

                <div class="standardized-help-text">
                  Use o sinal (-) para saques.
                </div>

                <div class="standardized-input-group">
                  <label for="data">Data</label>
                  <input type="date" id="data" name="data" />
                </div>

                <div class="standardized-input-group">
                  <label for="tipo">Tipo de Movimentação</label>
                  <input
                    type="text"
                    id="tipo"
                    name="tipo"
                    placeholder="Ex: Depósito, Saque, Rendimento..."
                  />
                  <div class="predefined-categories">
                    <span class="category-tag" onclick="setTipo('Depósito')"
                      >💵 Depósito</span
                    >
                    <span class="category-tag" onclick="setTipo('Saque')"
                      >💸 Saque</span
                    >
                    <span class="category-tag" onclick="setTipo('Rendimento')"
                      >📈 Rendimento</span
                    >
                    <span
                      class="category-tag"
                      onclick="setTipo('Transferência')"
                      >🔄 Transferência</span
                    >
                    <!-- PIX removido -->
                    <span class="category-tag" onclick="setTipo('Aplicação')"
                      >💼 Aplicação</span
                    >
                  </div>
                </div>

                <div class="standardized-input-group">
                  <label for="plano">Plano Vinculado</label>
                  <select id="plano" name="plano">
                    <option value="">Nenhum plano específico</option>
                    <!-- Opções carregadas dinamicamente do banco de dados -->
                  </select>
                </div>

                <div class="standardized-modal-actions">
                  <a
                    onclick="Modal.close()"
                    class="standardized-button standardized-button-secondary"
                    >Cancelar</a
                  >
                  <button
                    type="submit"
                    class="standardized-button standardized-button-primary"
                  >
                    💾 Salvar
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Toast personalizado removido - usando sistema toast padronizado -->

        <!-- =============================  Modal do Filtro (Padronizado) ============================-->
        <div class="standardized-modal-overlay filter-modal-overlay">
          <div class="standardized-modal">
            <div class="standardized-modal-header">
              <h2>🔍 Filtrar Poupança</h2>
              <button
                class="standardized-modal-close"
                onclick="FilterModal.close()"
              >
                ×
              </button>
            </div>

            <div class="standardized-modal-body">
              <form id="filter-form" onsubmit="filterPoupanca(event)">
                <div class="standardized-input-group">
                  <label for="filter-descricao">Descrição</label>
                  <input
                    type="text"
                    id="filter-descricao"
                    name="descricao"
                    placeholder="Ex: Depósito, Rendimento... (busca parcial)"
                  />
                </div>

                <div class="standardized-input-group">
                  <label for="filter-valor">Valor (R$)</label>
                  <input
                    type="number"
                    id="filter-valor"
                    name="valor"
                    placeholder="Ex: 500.00 (valor exato)"
                    step="0.01"
                  />
                </div>

                <div class="standardized-input-group">
                  <label for="filter-data">Data</label>
                  <input type="date" id="filter-data" name="data" />
                </div>

                <div class="standardized-input-group">
                  <label for="filter-tipo">Tipo</label>
                  <input
                    type="text"
                    id="filter-tipo"
                    name="tipo"
                    placeholder="Ex: Depósito, Saque, Rendimento..."
                  />
                </div>

                <div class="standardized-modal-actions">
                  <a
                    onclick="FilterModal.close()"
                    class="standardized-button standardized-button-secondary"
                    >Cancelar</a
                  >
                  <button
                    type="submit"
                    class="standardized-button standardized-button-primary"
                  >
                    🔍 Filtrar
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- =========================== Modal de Editar (Padronizado) ============================-->
        <div class="standardized-modal-overlay edit-modal-overlay">
          <div class="standardized-modal">
            <div class="standardized-modal-header">
              <h2>✏️ Editar Poupança</h2>
              <button
                class="standardized-modal-close"
                onclick="closeEditModal()"
              >
                ×
              </button>
            </div>

            <div class="standardized-modal-body">
              <form id="edit-form" onsubmit="submitEditForm(event)">
                <div class="standardized-input-group">
                  <label for="edit-description">Descrição</label>
                  <input
                    type="text"
                    id="edit-description"
                    name="description"
                    placeholder="Descrição da movimentação"
                  />
                </div>

                <div class="standardized-input-group">
                  <label for="edit-amount">Valor (R$)</label>
                  <input
                    type="number"
                    id="edit-amount"
                    name="amount"
                    placeholder="0,00"
                    step="0.01"
                  />
                </div>

                <div class="standardized-help-text">
                  Use o sinal (-) para saques.
                </div>

                <div class="standardized-input-group">
                  <label for="edit-date">Data</label>
                  <input type="date" id="edit-date" name="date" />
                </div>

                <div class="standardized-input-group">
                  <label for="edit-tipo">Tipo</label>
                  <input
                    type="text"
                    id="edit-tipo"
                    name="tipo"
                    placeholder="Ex: Depósito, Saque, Rendimento..."
                  />
                  <div class="predefined-categories">
                    <span class="category-tag" onclick="setEditTipo('Depósito')"
                      >💵 Depósito</span
                    >
                    <span class="category-tag" onclick="setEditTipo('Saque')"
                      >💸 Saque</span
                    >
                    <span
                      class="category-tag"
                      onclick="setEditTipo('Rendimento')"
                      >📈 Rendimento</span
                    >
                    <span
                      class="category-tag"
                      onclick="setEditTipo('Transferência')"
                      >🔄 Transferência</span
                    >
                    <!-- PIX removido -->
                    <span
                      class="category-tag"
                      onclick="setEditTipo('Aplicação')"
                      >💼 Aplicação</span
                    >
                  </div>
                </div>

                <div class="standardized-input-group">
                  <label for="edit-plano">Plano Vinculado (Opcional)</label>
                  <select id="edit-plano" name="plano">
                    <option value="">Nenhum plano vinculado</option>
                  </select>
                </div>

                <div class="standardized-modal-actions">
                  <a
                    onclick="closeEditModal()"
                    class="standardized-button standardized-button-secondary"
                    >Cancelar</a
                  >
                  <button
                    type="submit"
                    class="standardized-button standardized-button-primary"
                  >
                    💾 Salvar
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ====== Scripts ======= -->
    <script
      type="module"
      src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"
    ></script>
    <script
      nomodule
      src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"
    ></script>

    <!-- Supabase SDK (UMD) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <!-- Supabase Initialization -->
    <script src="../controllers/supabase-init.env"></script>

    <script src="../controllers/main.js"></script>
    <script src="../controllers/toast-system.js"></script>

    <!-- Supabase Guard -->
    <script src="../controllers/supabase-guard.env"></script>

    <script src="../models/poupanca.js"></script>

    <script>
      // Logout functionality
      document
        .getElementById("logoutBtn")
        ?.addEventListener("click", async function () {
          if (window.supabase) {
            await window.supabase.auth.signOut();
          }
          window.location.href = "../views/Login.html";
        });
    </script>
  </body>
</html>
